@page "/edit/{Id:guid}"
@page "/edit/new"
@page "/edit/{DateString}"
@using YourAppName.Services
@using YourAppName.Models
@inject JournalService JournalService
@inject NavigationManager Nav
@inject IJSRuntime JS

<div class="fade-in" style="max-width: 800px; margin: 0 auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <button class="nav-link" @onclick="GoBack" style="background: none; border: none; cursor: pointer;">
            <svg class="nav-icon" style="margin: 0;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
            Back
        </button>
        <div style="font-weight: 600; color: var(--text-muted);">@TargetDate.ToString("D")</div>
        <button class="btn-primary" @onclick="SaveEntry">Save Entry</button>
    </div>

    <div class="card">
        <input type="text" @bind="entry.Title" placeholder="Entry Title..." 
               style="width: 100%; font-size: 32px; font-weight: 700; border: none; outline: none; background: transparent; color: var(--text-main); margin-bottom: 24px;" />
        
        <div style="display: flex; gap: 24px; margin-bottom: 24px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
                <label style="display: block; font-size: 14px; color: var(--text-muted); margin-bottom: 8px;">Primary Mood (Required)</label>
                <select @bind="selectedCategory" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-main);">
                    <option value="">Select Category...</option>
                    @foreach (var cluster in moodClusters)
                    {
                        <option value="@cluster.Key">@cluster.Value.Emoji @cluster.Key</option>
                    }
                </select>
            </div>
            <div style="flex: 1; min-width: 250px;">
                <label style="display: block; font-size: 14px; color: var(--text-muted); margin-bottom: 8px;">Specific Moods (Max 2)</label>
                <div style="display: flex; gap: 8px; flex-wrap: wrap; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-main); min-height: 42px;">
                    @if (!string.IsNullOrEmpty(selectedCategory) && moodClusters.ContainsKey(selectedCategory))
                    {
                        @foreach (var m in moodClusters[selectedCategory].Moods)
                        {
                            <label style="font-size: 13px; display: flex; align-items: center; gap: 4px; cursor: pointer; background: var(--bg-card); padding: 4px 10px; border-radius: 20px; border: 1px solid var(--border); opacity: @(entry.SecondaryMoods.Count >= 2 && !IsSecondaryMoodSelected(m.Name) ? "0.5" : "1")">
                                <input type="checkbox" checked="@IsSecondaryMoodSelected(m.Name)" 
                                       disabled="@(entry.SecondaryMoods.Count >= 2 && !IsSecondaryMoodSelected(m.Name))"
                                       @onchange="(e) => ToggleSecondaryMood(m, e.Value)" />
                                @m.Emoji @m.Name
                            </label>
                        }
                    }
                    else
                    {
                        <span style="font-size: 12px; color: var(--text-muted); align-self: center;">Select a category first</span>
                    }
                </div>
            </div>

            <div style="flex: 1; min-width: 200px;">
                <label style="display: block; font-size: 14px; color: var(--text-muted); margin-bottom: 8px;">Entry Category</label>
                <select @bind="entry.Category" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-main);">
                    <option value="">Select Category...</option>
                    @foreach (var cat in categories)
                    {
                        <option value="@cat">@cat</option>
                    }
                </select>
            </div>

            <div style="flex: 1; min-width: 150px;">
                <label style="display: block; font-size: 14px; color: var(--text-muted); margin-bottom: 8px;">Security PIN (Optional)</label>
                <input type="password" @bind="entry.Pin" placeholder="Set 4-digit PIN..." maxlength="4"
                       style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-main);" />
            </div>
        </div>

        <div style="margin-bottom: 24px;">
            <label style="display: block; font-size: 14px; color: var(--text-muted); margin-bottom: 8px;">Tags (Comma separated)</label>
            <input type="text" @bind="tagsString" placeholder="Work, Health, Travel..." 
                   style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-main); margin-bottom: 12px;" />
            
            <label style="display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Quick Select Tags:</label>
            <div class="tag-container">
                @foreach (var tag in prebuiltTags)
                {
                    <button type="button" 
                            @onclick="() => ToggleTag(tag)"
                            class="tag-chip @(IsTagSelected(tag) ? "active" : "")">
                        @tag
                    </button>
                }
            </div>
        </div>

        <div @ref="quillEditor" style="width: 100%;"></div>
    </div>

    @if (entry.UpdatedAt != entry.CreatedAt)
    {
        <div style="text-align: right; color: var(--text-muted); font-size: 12px; margin-top: 12px;">
            Last updated: @entry.UpdatedAt.ToString("g")
        </div>
    }
    </div>


@if (showPinModal)
{
    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(4px);">
        <div class="card" style="width: 320px; text-align: center; padding: 32px;">
            <div style="font-size: 48px; margin-bottom: 16px;">üîí</div>
            <h3 style="margin-bottom: 8px;">Locked Entry</h3>
            <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 24px;">This entry is protected. Please enter the PIN to view.</p>
            <input type="password" @bind="enteredPin" maxlength="4"
                   style="width: 100%; padding: 12px; font-size: 24px; text-align: center; letter-spacing: 0.5em; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-main); margin-bottom: 24px;" 
                   placeholder="****" />
            @if (pinError)
            {
                <div style="color: #ef4444; font-size: 12px; margin-bottom: 16px;">Incorrect PIN. Please try again.</div>
            }
            <div style="display: flex; gap: 12px;">
                <button class="nav-link" @onclick="GoBack" style="flex: 1; justify-content: center;">Cancel</button>
                <button class="btn-primary" @onclick="VerifyPin" style="flex: 1;">Unlock</button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public Guid? Id { get; set; }
    [Parameter] public string DateString { get; set; }
    private DateTime TargetDate => DateTime.TryParse(DateString, out var d) ? d : DateTime.Today;

    private JournalEntry entry = new();
    private string _selectedCategory;
    private string selectedCategory
    {
        get => _selectedCategory;
        set
        {
            if (_selectedCategory != value)
            {
                _selectedCategory = value;
                entry.SecondaryMoods.Clear();
            }
        }
    }
    private string tagsString;

    private Dictionary<string, (string Emoji, List<Mood> Moods)> moodClusters = new()
    {
        { "Positive", ("üòä", new List<Mood> {
            new Mood { Name = "Happy", Category = MoodCategory.Positive, Emoji = "üòä" },
            new Mood { Name = "Excited", Category = MoodCategory.Positive, Emoji = "ü§©" },
            new Mood { Name = "Relaxed", Category = MoodCategory.Positive, Emoji = "üòå" },
            new Mood { Name = "Grateful", Category = MoodCategory.Positive, Emoji = "üôè" },
            new Mood { Name = "Confident", Category = MoodCategory.Positive, Emoji = "üòé" },
            new Mood { Name = "Inspired", Category = MoodCategory.Positive, Emoji = "‚ú®" },
            new Mood { Name = "Proud", Category = MoodCategory.Positive, Emoji = "üèÜ" }
        })},
        { "Neutral", ("üòê", new List<Mood> {
            new Mood { Name = "Calm", Category = MoodCategory.Neutral, Emoji = "üòê" },
            new Mood { Name = "Thoughtful", Category = MoodCategory.Neutral, Emoji = "ü§î" },
            new Mood { Name = "Curious", Category = MoodCategory.Neutral, Emoji = "üßê" },
            new Mood { Name = "Nostalgic", Category = MoodCategory.Neutral, Emoji = "üéûÔ∏è" },
            new Mood { Name = "Bored", Category = MoodCategory.Neutral, Emoji = "üò´" },
            new Mood { Name = "Busy", Category = MoodCategory.Neutral, Emoji = "‚è≥" },
            new Mood { Name = "Sleepy", Category = MoodCategory.Neutral, Emoji = "üò¥" }
        })},
        { "Negative", ("üòî", new List<Mood> {
            new Mood { Name = "Sad", Category = MoodCategory.Negative, Emoji = "üòî" },
            new Mood { Name = "Angry", Category = MoodCategory.Negative, Emoji = "üò†" },
            new Mood { Name = "Stressed", Category = MoodCategory.Negative, Emoji = "üò´" },
            new Mood { Name = "Lonely", Category = MoodCategory.Negative, Emoji = "üôÅ" },
            new Mood { Name = "Anxious", Category = MoodCategory.Negative, Emoji = "üò∞" },
            new Mood { Name = "Frustrated", Category = MoodCategory.Negative, Emoji = "üò§" },
            new Mood { Name = "Exhausted", Category = MoodCategory.Negative, Emoji = "ü•±" }
        })}
    };

    private string enteredPin;
    private bool showPinModal = false;
    private bool pinError = false;

    private List<string> categories = new() { "Work", "Personal", "Health", "Relationships", "Travel" };

    private List<string> prebuiltTags = new() 
    { 
        "Work", "Career", "Studies", "Family", "Friends", "Relationships", 
        "Health", "Fitness", "Personal Growth", "Self-care", "Hobbies", "Travel", "Nature", 
        "Finance", "Spirituality", "Birthday", "Holiday", "Vacation", "Celebration", "Exercise", 
        "Reading", "Writing", "Cooking", "Meditation", "Yoga", "Music", "Shopping", 
        "Parenting", "Projects", "Planning", "Reflection" 
    };

    private ElementReference quillEditor;
    private bool isInitialized = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !isInitialized)
        {
            await JS.InvokeVoidAsync("quillInterop.initialize", quillEditor, "Start writing your thoughts...");
            if (!string.IsNullOrEmpty(entry.Content))
            {
                await JS.InvokeVoidAsync("quillInterop.setContent", quillEditor, entry.Content);
            }
            isInitialized = true;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        if (Id.HasValue && Id.Value != Guid.Empty)
        {
            var existing = await JournalService.GetEntryById(Id.Value);
            if (existing != null)
            {
                entry = existing;
                if (!string.IsNullOrEmpty(entry.Pin)) showPinModal = true;
                selectedCategory = entry.PrimaryMood?.Name;
                tagsString = string.Join(", ", entry.Tags);
                return;
            }
        }

        if (DateString == "new" || string.IsNullOrEmpty(DateString) || DateString == "id")
        {
            entry = new JournalEntry { Date = DateTime.Today, Id = Guid.NewGuid() };
            return;
        }

        // Keep date-based lookup as a fallback for old links or specific date navigation
        var existingByDate = await JournalService.GetEntryByDate(TargetDate);
        if (existingByDate != null)
        {
            entry = existingByDate;
            if (!string.IsNullOrEmpty(entry.Pin)) showPinModal = true;
            selectedCategory = entry.PrimaryMood?.Name;
            tagsString = string.Join(", ", entry.Tags);
        }
        else
        {
            entry.Date = TargetDate;
            entry.Id = Guid.NewGuid();
        }
    }

    private async Task SaveEntry()
    {
        entry.Content = await JS.InvokeAsync<string>("quillInterop.getContent", quillEditor);
        if (!string.IsNullOrEmpty(selectedCategory) && moodClusters.ContainsKey(selectedCategory))
        {
            entry.PrimaryMood = new Mood 
            { 
                Name = selectedCategory, 
                Category = Enum.Parse<MoodCategory>(selectedCategory), 
                Emoji = moodClusters[selectedCategory].Emoji 
            };
        }
        entry.Tags = tagsString?.Split(',', StringSplitOptions.RemoveEmptyEntries).Select(s => s.Trim()).ToList() ?? new List<string>();
        await JournalService.SaveEntry(entry);
        Nav.NavigateTo("/");
    }

    private void VerifyPin()
    {
        if (enteredPin == entry.Pin)
        {
            showPinModal = false;
            pinError = false;
        }
        else
        {
            pinError = true;
            enteredPin = "";
        }
    }

    private bool IsSecondaryMoodSelected(string name) => entry.SecondaryMoods.Any(m => m.Name == name);

    private void ToggleSecondaryMood(Mood mood, object checkedValue)
    {
        if ((bool)checkedValue)
        {
            if (entry.SecondaryMoods.Count < 2 && !entry.SecondaryMoods.Any(m => m.Name == mood.Name))
            {
                entry.SecondaryMoods.Add(mood);
            }
        }
        else
        {
            var existing = entry.SecondaryMoods.FirstOrDefault(m => m.Name == mood.Name);
            if (existing != null) entry.SecondaryMoods.Remove(existing);
        }
    }

    private void GoBack() => Nav.NavigateTo("/");

    private void ToggleTag(string tag)
    {
        var currentTags = tagsString?.Split(',', StringSplitOptions.RemoveEmptyEntries)
                                    .Select(s => s.Trim())
                                    .ToList() ?? new List<string>();
        
        if (currentTags.Any(t => string.Equals(t, tag, StringComparison.OrdinalIgnoreCase)))
        {
            currentTags.RemoveAll(t => string.Equals(t, tag, StringComparison.OrdinalIgnoreCase));
        }
        else
        {
            currentTags.Add(tag);
        }
        
        tagsString = string.Join(", ", currentTags);
    }

    private bool IsTagSelected(string tag)
    {
        if (string.IsNullOrWhiteSpace(tagsString)) return false;
        
        return tagsString.Split(',', StringSplitOptions.RemoveEmptyEntries)
                         .Select(s => s.Trim())
                         .Any(t => string.Equals(t, tag, StringComparison.OrdinalIgnoreCase));
    }
}
