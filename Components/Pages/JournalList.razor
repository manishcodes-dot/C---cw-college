@page "/entries"
@using YourAppName.Services
@using YourAppName.Models
@inject JournalService JournalService
@inject NavigationManager Nav
@inject IJSRuntime JS

<div class="fade-in">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
        <h1>Journal Entries</h1>

        <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-end; background: var(--bg-card); padding: 16px; border-radius: 12px; border: 1px solid var(--border); box-shadow: var(--shadow);">
            <div style="display: flex; flex-direction: column; gap: 4px;">
                <label style="font-size: 12px; color: var(--text-muted); font-weight: 600;">MOOD</label>
                <select @bind="selectedMood" @bind:after="PerformSearch" style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-main); font-size: 14px; min-width: 140px; cursor: pointer;">
                    <option value="">All Moods</option>
                    @foreach (var mood in uniqueMoods)
                    {
                        <option value="@mood">@mood</option>
                    }
                </select>
            </div>

            <div style="display: flex; flex-direction: column; gap: 4px;">
                <label style="font-size: 12px; color: var(--text-muted); font-weight: 600;">TAG</label>
                <select @bind="selectedTag" @bind:after="PerformSearch" style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-main); font-size: 14px; min-width: 140px; cursor: pointer;">
                    <option value="">All Tags</option>
                    @foreach (var tag in uniqueTags)
                    {
                        <option value="@tag">#@tag</option>
                    }
                </select>
            </div>

            <div style="display: flex; flex-direction: column; gap: 4px; flex: 1; min-width: 200px;">
                <label style="font-size: 12px; color: var(--text-muted); font-weight: 600;">SEARCH</label>
                <div style="position: relative;">
                    <input type="text"
                           placeholder="Search titles, content, or dates..."
                           @bind="searchQuery"
                           @bind:event="oninput"
                           @onkeyup="PerformSearch"
                           style="width: 100%; padding: 8px 12px 8px 36px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text-main); font-size: 14px;" />
                    <svg style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; color: var(--text-muted);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </div>
            </div>
            
            @if (!string.IsNullOrEmpty(searchQuery) || !string.IsNullOrEmpty(selectedMood) || !string.IsNullOrEmpty(selectedTag))
            {
                <button @onclick="ClearSearch" style="padding: 8px 16px; border-radius: 8px; border: none; background: rgba(99, 102, 241, 0.1); color: var(--primary); font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                    Reset Filters
                </button>
            }
        </div>
    </div>

    @if (!filteredEntries.Any())
    {
        <div class="card" style="text-align: center; padding: 64px;">
            <p style="color: var(--text-muted); margin-bottom: 24px;">
                No entries found matching your search.
            </p>

            <button class="btn-primary" @onclick="ClearSearch">
                Clear Search
            </button>
        </div>
    }
    else
    {
        <div style="display: flex; flex-direction: column; gap: 24px;">
            @foreach (var entry in filteredEntries)
            {
                <div class="card"
                     style="cursor: pointer; transition: transform 0.2s;"
                     @onclick="() => EditEntry(entry.Id)">

                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                        <div>
                            <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 4px;">
                                @entry.Date.ToString("dddd, MMMM dd, yyyy")
                            </div>
                            <h2 style="margin: 0; font-size: 22px;">
                                @entry.Title
                            </h2>
                        </div>

                        <div style="display: flex; align-items: center; gap: 12px;">
                            @if (!string.IsNullOrEmpty(entry.Pin))
                            {
                                <span title="Locked Entry" style="font-size: 16px; color: var(--text-muted);">ðŸ”’</span>
                            }

                            <span style="font-size: 24px;">
                                @entry.PrimaryMood?.Emoji
                            </span>

                        <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                            <button class="nav-link"
                                    style="color: #ef4444; padding: 4px;"
                                    @onclick:stopPropagation="true"
                                    @onclick="() => DeleteEntry(entry.Id)">
                                ðŸ—‘
                            </button>
                            <button class="nav-link"
                                    style="color: var(--primary); padding: 4px;"
                                    title="Export to PDF"
                                    @onclick:stopPropagation="true"
                                    @onclick="() => ExportToPdf(entry)">
                                ðŸ“¥
                            </button>
                        </div>
                        </div>
                    </div>

                    <p style="color: var(--text-main); line-height: 1.6; margin-bottom: 16px;">
                        @entry.PlainTextContent
                    </p>

                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        @if (!string.IsNullOrEmpty(entry.Category))
                        {
                            <span style="background: rgba(99,102,241,0.1);
                                         color: var(--primary);
                                         padding: 4px 12px;
                                         border-radius: 16px;
                                         font-size: 12px;
                                         font-weight: 600;">
                                @entry.Category
                            </span>
                        }

                        @foreach (var tag in entry.Tags)
                        {
                            <span style="background: var(--bg-main);
                                         color: var(--text-muted);
                                         padding: 4px 12px;
                                         border-radius: 16px;
                                         font-size: 12px;
                                         border: 1px solid var(--border);">
                                #@tag
                            </span>
                        }
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<JournalEntry> filteredEntries = new();
    private List<string> uniqueMoods = new();
    private List<string> uniqueTags = new();
    private string searchQuery = "";
    private string selectedMood = "";
    private string selectedTag = "";

    protected override async Task OnInitializedAsync()
    {
        var allEntries = await JournalService.GetAllEntries();
        
        uniqueMoods = allEntries
            .SelectMany(e => new[] { e.PrimaryMood?.Name }.Concat(e.SecondaryMoods.Select(m => m.Name)))
            .Where(m => !string.IsNullOrEmpty(m))
            .Distinct()
            .OrderBy(m => m)
            .ToList();
            
        uniqueTags = allEntries
            .SelectMany(e => e.Tags)
            .Where(t => !string.IsNullOrEmpty(t))
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .OrderBy(t => t)
            .ToList();

        filteredEntries = allEntries;
    }

    private async Task PerformSearch()
    {
        filteredEntries = await JournalService.Search(searchQuery, selectedMood, selectedTag);
    }

    private async Task ClearSearch()
    {
        searchQuery = "";
        selectedMood = "";
        selectedTag = "";
        await PerformSearch();
    }

    private void EditEntry(Guid id)
    {
        Nav.NavigateTo($"/edit/{id}");
    }

    private async Task DeleteEntry(Guid id)
    {
        await JournalService.DeleteEntry(id);
        await PerformSearch();
    }

    private async Task ExportToPdf(JournalEntry entry)
    {
        await JS.InvokeVoidAsync("quillInterop.exportToPdf", 
            entry.Title, 
            entry.Content, 
            entry.Date.ToString("yyyy-MM-dd"), 
            entry.PrimaryMood?.Emoji + " " + entry.PrimaryMood?.Name,
            entry.Category,
            entry.Tags);
    }
}
